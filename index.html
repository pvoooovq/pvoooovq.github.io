<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Google Sheets Form</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 40px auto; line-height: 1.5; }
    label { display: inline-block; width: 64px; }
    input, textarea { width: 100%; max-width: 420px; }
    .row { margin: 8px 0; }
    .actions { margin-top: 12px; display: flex; gap: 8px; }
    button { padding: 8px 12px; cursor: pointer; }
    ul { padding-left: 16px; }
    li { margin: 6px 0; cursor: pointer; }
    li span.meta { color: #666; font-size: 12px; }
    .hint { color: #888; font-size: 12px; margin-left: 6px; }
    .danger { background: #fff0f0; border: 1px solid #ffd0d0; }
  </style>
</head>
<body>
  <h2>문의하기</h2>

  <!-- 편집 대상 id -->
  <input type="hidden" id="recordId" />

  <div class="row">
    <label for="name">이름</label>
    <input id="name" type="text" />
  </div>
  <div class="row">
    <label for="email">이메일</label>
    <input id="email" type="email" />
  </div>
  <div class="row">
    <label for="message">메시지</label>
    <textarea id="message" rows="4"></textarea>
  </div>

  <div class="actions">
    <button id="submitBtn">저장</button>
    <button id="resetBtn" type="button">초기화</button>
    <button id="deleteBtn" type="button" class="danger" style="display:none">삭제</button>
    <span class="hint" id="modeHint">현재: 새 항목 추가 모드</span>
  </div>

  <h3>저장된 데이터</h3>
  <ul id="dataList"></ul>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxleObVAB8ojj6QPPEeb-wG4vFvWg3MU3ks0aSFXT99LBlYpihTeY7qY1wgfHkTtrvT9Q/exec"; // 예) https://script.google.com/macros/s/XXXX/exec

    let editMode = false; // false: create, true: update

    // 유틸
    function getForm() {
      return {
        id: document.getElementById('recordId').value.trim(),
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        message: document.getElementById('message').value.trim()
      };
    }
    function setForm({id="", name="", email="", message=""}) {
      document.getElementById('recordId').value = id;
      document.getElementById('name').value = name;
      document.getElementById('email').value = email;
      document.getElementById('message').value = message;
    }
    function clearForm() {
      setForm({ id:"", name:"", email:"", message:"" });
    }
    function setModeUpdate(on, labelSuffix="") {
      editMode = on;
      const submitBtn = document.getElementById('submitBtn');
      const deleteBtn = document.getElementById('deleteBtn');
      const modeHint = document.getElementById('modeHint');

      if (on) {
        submitBtn.textContent = "수정하기";
        deleteBtn.style.display = "inline-block";
        modeHint.textContent = "현재: 수정 모드" + (labelSuffix ? ` (${labelSuffix})` : "");
      } else {
        submitBtn.textContent = "저장";
        deleteBtn.style.display = "none";
        modeHint.textContent = "현재: 새 항목 추가 모드";
      }
    }

    // 목록 로드
    async function loadList() {
      const res = await fetch(API_URL);
      const json = await res.json();
      const data = json.data || [];
      const list = document.getElementById('dataList');
      list.innerHTML = "";

      // 최신이 위로
      data.sort((a, b) => Number(b.id) - Number(a.id));

      data.forEach(item => {
        const li = document.createElement('li');
        li.addEventListener('click', () => {
          setForm({ id: String(item.id), name: item.name ?? "", email: item.email ?? "", message: item.message ?? "" });
          setModeUpdate(true, `${item.name}`);
          document.getElementById('name').focus();
        });
        li.innerHTML = `
          <strong>${escapeHTML(item.name || "(이름없음)")}</strong>
          <span class="meta"> • ${escapeHTML(item.email || "")}</span><br/>
          ${escapeHTML(item.message || "")}
        `;
        list.appendChild(li);
      });
    }

    // 저장/수정
    document.getElementById('submitBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      const form = getForm();

      if (!form.name || !form.email || !form.message) {
        alert("이름/이메일/메시지를 모두 입력해줘.");
        return;
      }

      let payload;
      if (editMode && form.id) {
        payload = { action: "update", id: form.id, name: form.name, email: form.email, message: form.message };
      } else {
        payload = { action: "create", name: form.name, email: form.email, message: form.message };
      }

      const res = await fetch(API_URL, {
        method: "POST",
        // 헤더를 생략하면 text/plain으로 보내져서 프리플라이트를 피하기 쉬움
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      if (!result.ok) {
        alert("실패: " + (result.error || "알 수 없는 오류"));
        return;
      }

      // 성공 시 초기화 + 목록 갱신
      clearForm();
      setModeUpdate(false);
      await loadList();
    });

    // 초기화
    document.getElementById('resetBtn').addEventListener('click', (e) => {
      e.preventDefault();
      clearForm();
      setModeUpdate(false);
    });

    // 삭제 (편집 모드에서만)
    document.getElementById('deleteBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      const { id, name } = getForm();
      if (!id) return;
      if (!confirm(`정말 삭제할까요?\n대상: ${name || "(이름없음)"} / ID: ${id}`)) return;

      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "delete", id })
      });
      const result = await res.json();
      if (!result.ok) {
        alert("삭제 실패: " + (result.error || "알 수 없는 오류"));
        return;
      }

      clearForm();
      setModeUpdate(false);
      await loadList();
    });

    // XSS 방지용
    function escapeHTML(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    // 첫 로드
    loadList();
  </script>
</body>
</html>
