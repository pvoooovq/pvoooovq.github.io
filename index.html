<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Google Sheets Form</title>
  <style>
    body { max-width:700px; margin:30px auto; font-family:sans-serif; }
    label { display:inline-block; width:60px; }
    input, textarea { width:100%; max-width:400px; margin-bottom:8px; }
    button { margin-right:6px; }
    li { cursor:pointer; margin:4px 0; }
    .meta { color:#666; font-size:12px; }
  </style>
</head>
<body>
  <h2>문의하기</h2>
  <input type="hidden" id="recordId">
  <div><label>이름</label><input id="name"></div>
  <div><label>이메일</label><input id="email"></div>
  <div><label>메시지</label><textarea id="message"></textarea></div>
  <div>
    <button id="saveBtn">저장</button>
    <button id="resetBtn">초기화</button>
    <button id="deleteBtn" style="display:none">삭제</button>
    <span id="mode">새 항목 추가</span>
  </div>
  <h3>저장된 데이터</h3>
  <ul id="list"></ul>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxleObVAB8ojj6QPPEeb-wG4vFvWg3MU3ks0aSFXT99LBlYpihTeY7qY1wgfHkTtrvT9Q/exec";
    let editMode = false;

    async function loadData() {
      const res = await fetch(API_URL);
      const json = await res.json();
      const list = document.getElementById("list");
      list.innerHTML = "";
      json.data.sort((a,b)=>b.id-a.id).forEach(item=>{
        const li=document.createElement("li");
        li.innerHTML=`<b>${item.name}</b> <span class="meta">${item.email}</span><br>${item.message}`;
        li.onclick=()=>{ fillForm(item); };
        list.appendChild(li);
      });
    }

    function fillForm(item){
      document.getElementById("recordId").value=item.id;
      document.getElementById("name").value=item.name;
      document.getElementById("email").value=item.email;
      document.getElementById("message").value=item.message;
      document.getElementById("mode").textContent="수정 모드";
      document.getElementById("deleteBtn").style.display="inline";
      document.getElementById("saveBtn").textContent="수정";
      editMode=true;
    }

    async function saveData(){
      const id=document.getElementById("recordId").value;
      const name=document.getElementById("name").value.trim();
      const email=document.getElementById("email").value.trim();
      const message=document.getElementById("message").value.trim();
      if(!name||!email||!message){ alert("모두 입력해주세요"); return; }

      const action=editMode?"update":"create";
      const body={action,id,name,email,message};

      const res=await fetch(API_URL,{method:"POST",body:JSON.stringify(body)});
      const json=await res.json();
      if(json.ok) alert(json.msg || "성공");
      resetForm();
      loadData();
    }

    async function deleteData(){
      const id=document.getElementById("recordId").value;
      if(!id) return;
      if(!confirm("정말 삭제할까요?")) return;
      const res=await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"delete",id})});
      const json=await res.json();
      if(json.ok) alert(json.msg || "삭제됨");
      resetForm();
      loadData();
    }

    function resetForm(){
      document.getElementById("recordId").value="";
      document.getElementById("name").value="";
      document.getElementById("email").value="";
      document.getElementById("message").value="";
      document.getElementById("mode").textContent="새 항목 추가";
      document.getElementById("deleteBtn").style.display="none";
      document.getElementById("saveBtn").textContent="저장";
      editMode=false;
    }

    document.getElementById("saveBtn").onclick=saveData;
    document.getElementById("resetBtn").onclick=()=>{ resetForm(); alert("초기화됨"); };
    document.getElementById("deleteBtn").onclick=deleteData;

    loadData();
  </script>
</body>
</html>
